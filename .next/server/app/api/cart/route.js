"use strict";(()=>{var e={};e.id=6453,e.ids=[6453],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},80330:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>I,patchFetch:()=>z,requestAsyncStorage:()=>x,routeModule:()=>w,serverHooks:()=>v,staticGenerationAsyncStorage:()=>_});var r={};i.r(r),i.d(r,{GET:()=>f,PATCH:()=>y,POST:()=>h});var s=i(49303),n=i(88716),a=i(60670),o=i(87070),d=i(75571),u=i(23174),c=i(77051),l=i(21067);let p=l.Ry({productId:l.Z_(),size:l.Z_().optional(),qty:l.Rx().int().min(1).max(99)}),m=l.Ry({lines:l.IX(p)});async function q(e){let t=await c._.cart.findUnique({where:{userId:e},include:{lines:!0}});return t||(t=await c._.cart.create({data:{userId:e},include:{lines:!0}})),t}async function f(){let e=await (0,d.getServerSession)(u.L),t=e?.user?.id;if(!t)return o.NextResponse.json({lines:[]});let i=await c._.cart.findUnique({where:{userId:t},include:{lines:!0}});return o.NextResponse.json({lines:(i?.lines||[]).map(e=>({productId:e.productId,size:e.size||void 0,qty:e.qty,priceCentsSnapshot:e.priceCentsSnapshot}))})}async function h(e){let t=await (0,d.getServerSession)(u.L),i=t?.user?.id;if(!i)return o.NextResponse.json({error:"unauthenticated"},{status:401});let r=await e.json().catch(()=>null),s=m.safeParse(r);if(!s.success)return o.NextResponse.json({error:"invalid_payload"},{status:400});let n=await q(i);await c._.cartLine.deleteMany({where:{cartId:n.id}});let a=await Promise.all(s.data.lines.map(async e=>{let t=await c._.product.findUnique({where:{id:e.productId},include:{sizes:!0}});if(!t||t.deletedAt)return null;let i=e.qty;if(e.size){let r=t.sizes.find(t=>t.label===e.size);if(!r||(i=Math.min(i,r.stock,99))<=0)return null}else i=Math.min(i,99);return c._.cartLine.create({data:{cartId:n.id,productId:t.id,size:e.size,qty:i,priceCentsSnapshot:t.priceCents}})}));return o.NextResponse.json({ok:!0,created:a.filter(Boolean).length})}async function y(e){let t=await (0,d.getServerSession)(u.L),i=t?.user?.id;if(!i)return o.NextResponse.json({error:"unauthenticated"},{status:401});let r=await e.json().catch(()=>null),s=m.safeParse(r);if(!s.success)return o.NextResponse.json({error:"invalid_payload"},{status:400});let n=await q(i);for(let e of s.data.lines){let t=await c._.product.findUnique({where:{id:e.productId},include:{sizes:!0}});if(!t||t.deletedAt)continue;let i=await c._.cartLine.findFirst({where:{cartId:n.id,productId:e.productId,size:e.size||null}}),r=e.qty;if(e.size){let s=t.sizes.find(t=>t.label===e.size);if(!s||(r=Math.min(i?i.qty+e.qty:e.qty,s.stock,99))<=0)continue}else r=Math.min(i?i.qty+e.qty:e.qty,99);i?await c._.cartLine.update({where:{id:i.id},data:{qty:r}}):await c._.cartLine.create({data:{cartId:n.id,productId:t.id,size:e.size,qty:r,priceCentsSnapshot:t.priceCents}})}let a=await c._.cart.findUnique({where:{id:n.id},include:{lines:!0}});return o.NextResponse.json({lines:a?.lines.map(e=>({productId:e.productId,size:e.size||void 0,qty:e.qty,priceCentsSnapshot:e.priceCentsSnapshot}))||[]})}let w=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/cart/route",pathname:"/api/cart",filename:"route",bundlePath:"app/api/cart/route"},resolvedPagePath:"/Users/ishaqbello/Website/asos-clone/app/api/cart/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:_,serverHooks:v}=w,I="/api/cart/route";function z(){return(0,a.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:_})}},82405:(e,t,i)=>{i.d(t,{G:()=>n,c:()=>s});var r=i(98691);async function s(e){return r.ZP.hash(e,10)}async function n(e,t){return r.ZP.compare(e,t)}},23174:(e,t,i)=>{i.d(t,{L:()=>u});var r=i(53797),s=i(77210),n=i(21067),a=i(77051),o=i(82405);let d=n.Ry({email:n.Z_().email(),password:n.Z_().min(3)}),u={providers:[(0,r.Z)({name:"Credentials",credentials:{email:{},password:{}},async authorize(e){let t=d.safeParse(e);if(!t.success)return null;let{email:i,password:r}=t.data,s=await a._.user.findUnique({where:{email:i}});return s&&await (0,o.G)(r,s.passwordHash)?{id:s.id,name:s.name||null,email:s.email,isAdmin:s.isAdmin}:null}}),...process.env.GITHUB_ID&&process.env.GITHUB_SECRET?[(0,s.Z)({clientId:process.env.GITHUB_ID,clientSecret:process.env.GITHUB_SECRET})]:[]],session:{strategy:"jwt"},callbacks:{async jwt({token:e,user:t}){if(t?.id)e.uid=t.id,e.isAdmin=t.isAdmin||!1;else if(e.uid&&void 0===e.isAdmin){let t=await a._.user.findUnique({where:{id:e.uid}});t&&(e.isAdmin=t.isAdmin)}return e},session:async({session:e,token:t})=>(t?.uid&&(e.user.id=t.uid),t?.isAdmin!==void 0&&(e.user.isAdmin=t.isAdmin),e)}}},77051:(e,t,i)=>{i.d(t,{_:()=>s});let r=require("@prisma/client"),s=global.__prisma||new r.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[9276,3550,5747,5972],()=>i(80330));module.exports=r})();